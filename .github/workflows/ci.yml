name: CI

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v1

      - name: Format
        run: cargo fmt -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check
        run: cargo check --all-targets

      - name: Test
        run: |
          set -o pipefail
          cargo test --all-targets --all-features 2>&1 | tee test.log

      - name: Test Summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('test.log', 'utf8');
            let totalPassed = 0;
            let totalFailed = 0;
            let current = '';
            const details = [];
            for (const line of log.split('\n')) {
              const run = line.match(/Running .*deps\/(.+?)-[a-f0-9]+\)/);
              if (run) current = run[1];
              const m = line.match(/test result: .*?(\d+) passed; (\d+) failed.*finished in ([0-9.]+)s/);
              if (m) {
                const passed = parseInt(m[1], 10);
                const failed = parseInt(m[2], 10);
                totalPassed += passed;
                totalFailed += failed;
                details.push(`- ${current || 'crate'}: ${passed} passed, ${failed} failed (${m[3]}s)`);
                current = '';
              }
            }
            let body = '**Test Summary**\n';
            body += details.join('\n');
            body += `\n**Totals**: ${totalPassed} passed, ${totalFailed} failed`;
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            } else {
              console.log(body);
            }
